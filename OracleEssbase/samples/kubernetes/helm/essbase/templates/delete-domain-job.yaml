#
# Copyright (c) 2021, Oracle and/or its affiliates.
# Licensed under the Universal Permissive License v 1.0 as shown at https://oss.oracle.com/licenses/upl.
#

apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "essbase.fullname" . }}-delete-domain
  labels:
  {{- include "essbase.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
      {{- include "essbase.labels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
      {{- toYaml . | nindent 6 }}
      {{- end }}
      containers:
      - name: delete-essbase-domain-job
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        volumeMounts:
        - name: essbase-scripts
          mountPath: /essbase-scripts
          readOnly: true
        - name: database-admin-secrets
          mountPath: "/run/secrets/database"
          readOnly: true
        {{- with .Values.volumeMounts }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        env:
        {{- include "essbase.commonEnv" . | nindent 8 }}
        command: [ "sh" ]
        args: [ "/essbase-scripts/delete-domain.sh" ]
      volumes:
      - name: essbase-scripts
        configMap:
          name: {{ include "essbase.fullname" . }}-essbase-scripts
      - name: database-admin-secrets
        secret:
          secretName: {{ .Values.database.adminCredentialsSecret }}
          items:
          - key: username
            path: admin_username
          - key: password
            path: admin_password
      {{- with .Values.volumes }}
      {{- toYaml . | nindent 6 }}
      {{- end }}

